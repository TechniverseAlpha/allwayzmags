<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Allwayz Product Catalog (Detailed View)</title>
<style>
body {font-family:'Segoe UI',sans-serif;background:#fafafa;margin:0;}
header {background:black;color:white;display:flex;align-items:center;padding:10px 20px;position:sticky;top:0;z-index:1000;}
header img {height:50px;margin-right:15px;}
.sidebar {width:260px;position:fixed;top:90px;bottom:0;left:0;background:#1A237E;color:white;overflow-y:auto;padding:15px;}
.main {margin-left:280px;padding:20px;}
.thumb {width:200px;height:auto;cursor:pointer;border-radius:6px;transition:0.2s;}
.thumb:hover {transform:scale(1.05);}
.grid {display:flex;flex-wrap:wrap;gap:25px;}
.card {width:200px;text-align:center;background:white;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,0.1);padding:10px;}
.popup {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;}
.popup img {max-width:90%;max-height:90%;border-radius:8px;}
button {background:#1A237E;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;margin-top:10px;width:100%;}
.status-AVAILABLE {color:#2E7D32;font-weight:bold;}
.status-POTENTIAL {color:#FBC02D;font-weight:bold;}
.status-NOT_ALLOWED {color:#C62828;font-weight:bold;}
.accordion-item {background:#283593;margin-bottom:5px;border-radius:4px;}
.accordion-item h3 {margin:0;padding:10px;cursor:pointer;font-size:15px;}
.accordion-content {display:none;padding:10px;background:#3949AB;font-size:13px;line-height:1.4;}
input {width:100%;padding:6px;margin-bottom:10px;border:none;border-radius:4px;}
small {color:#666;font-size:12px;}
</style>
</head>
<body>
<header>
  <img src="ALLWAYZ_MAGS_LOGO.png" alt="Allwayz Logo">
  <h1>Allwayz Product Catalog</h1>
</header>

<div class="sidebar">
  <h2>Filters</h2>
  <input type="text" id="search" placeholder="Search...">
  <div id="accordion"></div>
  <button onclick="generatePDF()">Generate PDF Catalog</button>
</div>

<div class="main">
  <div id="gallery" class="grid"></div>
</div>

<div id="popup" class="popup" onclick="this.style.display='none'"><img id="popup-img"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ----------------------------------------------------------
   Allwayz Catalog Viewer v7.2 ‚Äì Detailed Card Mode
---------------------------------------------------------- */
let data = {};

Promise.all([
 'data/DesignCategoryStatus.csv',
 'data/Categories.csv',
 'data/Designs.csv'
].map(f => fetch(f).then(r => r.ok ? r.text() : '')))
.then(res => {
  const clean = txt => Papa.parse(txt, { header: true }).data
    .filter(r => r && Object.values(r).some(v => v && v.toString().trim() !== ''));
  data.status = clean(res[0] || '');
  data.categories = clean(res[1] || '');
  data.designs = clean(res[2] || '');
  console.log("‚úÖ Data loaded:", {
    categories: data.categories.length,
    designs: data.designs.length,
    status: data.status.length
  });
  init();
});

function safe(str){ return (str ?? '').toString(); }

function init(){
  buildAccordion();
  render();
  document.getElementById('search').oninput = () => render();
}

function buildAccordion(){
  const acc = document.getElementById('accordion');
  acc.innerHTML = '';
  data.categories.forEach(c => {
    const category = safe(c.category_name);
    if (!category) return;
    const related = data.status.filter(p => safe(p.category_name) === category);
    const inner = related.map(p=>{
      if(!p || !p.design_name) return '';
      const design = safe(p.design_name);
      const status = safe(p.status);
      return `
        <div class='design-item'
             onclick="filterDesign('${category.replace(/'/g,"\\'")}', '${design.replace(/'/g,"\\'")}')">
          <span class='status-${status}'>‚Ä¢</span> ${design}
        </div>`;
    }).join('');
    const div = document.createElement('div');
    div.className = 'accordion-item';
    div.innerHTML = `
      <h3 onclick="toggleAccordion(this)">${category}</h3>
      <div class='accordion-content'>${inner || '<i>No designs found</i>'}</div>`;
    acc.appendChild(div);
  });
}

function toggleAccordion(el){
  const c = el.nextElementSibling;
  c.style.display = c.style.display === 'block' ? 'none' : 'block';
}

async function imageExists(url){
  try { const res = await fetch(url, { method: 'HEAD' }); return res.ok; }
  catch { return false; }
}

async function filterDesign(category, design) {
  console.log("üü¶ filterDesign triggered:", category, ">", design);
  const gal = document.getElementById('gallery');
  gal.innerHTML = '';

  const match = data.status.find(p =>
    safe(p.category_name).toLowerCase() === category.toLowerCase() &&
    safe(p.design_name).toLowerCase() === design.toLowerCase()
  );

  const cleanName = safe(design).trim().toUpperCase().replace(/[^A-Z0-9]+/g, '_');
  const jpgPath = `images/${cleanName}.jpg`;

  let imgPath = '';
  if (await imageExists(jpgPath)) imgPath = jpgPath;
  else {
    gal.innerHTML = `<p style="color:#666;font-style:italic;">
      ‚ö†Ô∏è No image found for <b>${design}</b> (expected: ${jpgPath})
    </p>`;
    console.warn("‚ö†Ô∏è Missing:", jpgPath);
    return;
  }

  const div = document.createElement('div');
  const code = match ? safe(match.design_code) : '‚Äî';
  const status = match ? safe(match.status) : 'UNKNOWN';
  div.className = 'card';
  div.innerHTML = `
    <img class="thumb" src="${imgPath}" onclick="showPopup('${jpgPath}')">
    <div style="margin-top:6px;">
      <b>${design}</b><br>
      <small>${category}</small><br>
      <span class="status-${status}">${status}</span><br>
      <small>Code: ${code}</small>
    </div>`;
  gal.appendChild(div);
}

function render(){
  const term = safe(document.getElementById('search').value).toLowerCase();
  const gal = document.getElementById('gallery');
  gal.innerHTML = '';

  const filtered = data.status.filter(p =>
    safe(p.design_name).toLowerCase().includes(term) ||
    safe(p.category_name).toLowerCase().includes(term)
  );

  for (const p of filtered) {
    const design = safe(p.design_name);
    const category = safe(p.category_name);
    const code = safe(p.design_code);
    const status = safe(p.status);
    const cleanName = design.trim().toUpperCase().replace(/[^A-Z0-9]+/g, '_');
    const jpgPath = `images/${cleanName}.jpg`;

    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img class="thumb" src="${jpgPath}" onerror="this.style.display='none'">
      <div style="margin-top:6px;">
        <b>${design}</b><br>
        <small>${category}</small><br>
        <span class="status-${status}">${status}</span><br>
        <small>Code: ${code}</small>
      </div>`;
    gal.appendChild(div);
  }
}

function showPopup(src){
  document.getElementById('popup-img').src = src;
  document.getElementById('popup').style.display = 'flex';
}

async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const elements = document.querySelectorAll('#gallery .card');
  let y = 10;
  for (const el of elements) {
    const canvas = await html2canvas(el);
    const img = canvas.toDataURL('image/jpeg', 0.8);
    pdf.addImage(img, 'JPEG', 10, y, 60, 70);
    y += 75;
    if (y > 260) { pdf.addPage(); y = 10; }
  }
  pdf.save('AllwayzCatalog.pdf');
  console.log("üìÑ PDF generated");
}
</script>
</body>
</html>
